javascript:(async function(){try{var m=location.href.match(//studios/(\d+)/);if(!m){alert("スタジオページで実行してください");return;}var id=m[1];var hrs=prompt("何時間以内のコメントを対象にしますか？ (空白＝全件)","");if(hrs===null)return;var hours=hrs.trim()===""?null:parseFloat(hrs.trim());if(hours!==null&&isNaN(hours)){alert("時間は数値で入力してください");return;}var cutoff=hours===null?null:Date.now()-hours36001000;var user=prompt("ユーザー名指定（空白で全員）:","");if(user===null)return;user=user.trim().toLowerCase();var kw=prompt("本文キーワード（空白で全件）:","");if(kw===null)return;kw=kw.trim();var limit=40,batch=30,maxPages=1e12,MAX_FETCHED=1e12;function tms(c){var d=c.datetime_created||c.datetime||c.created_at||c.created||(c.history&&(c.history.created||(Array.isArray(c.history)&&c.history[0]&&c.history[0].modified)));if(!d)return null;var ms=Date.parse(d);if(!isFinite(ms)){var p=String(d).split(/[-T:.Z]/).map(Number);if(p.length>=6)ms=Date.UTC(p[0],p[1]-1,p[2],p[3],p[4],p[5]);else ms=null;}return ms;}async function fj(u,r=5){try{var res=await fetch(u);if(!res.ok){throw new Error("HTTP "+res.status);}return await res.json();}catch(err){if(r>0){await new Promise(resolve=>setTimeout(resolve,50));return fj(u,r-1);}return[];}}var pageIndex=0,all=[],total=0,stop=false;var progressDiv=document.createElement("div");progressDiv.style.cssText="position:fixed;top:8px;right:8px;background:#fff7c0;border:1px solid #333;padding:6px;z-index:2147483647;font-size:13px;border-radius:6px;";var progressSpan=document.createElement("span");progressSpan.textContent="取得中… 0 件";var stopBtn=document.createElement("button");stopBtn.textContent="途中終了";stopBtn.style.marginLeft="8px";stopBtn.onclick=function(){stop=true;stopBtn.disabled=true;stopBtn.textContent="停止中...";};progressDiv.appendChild(progressSpan);progressDiv.appendChild(stopBtn);document.documentElement.appendChild(progressDiv);outer:while(true){if(pageIndex>=maxPages||stop)break;var pages=[];for(var i=0;i<batch&&(pageIndex+i)<maxPages;i++)pages.push(pageIndex+i);if(pages.length===0)break;var urls=pages.map(pi=>'https://api.scratch.mit.edu/studios/'+id+'/comments?limit='+limit+'&offset='+pi*limit);var batches=await Promise.all(urls.map(u=>fj(u)));var replyPromises=[];for(var bi=0;bi<batches.length;bi++){var arr=Array.isArray(batches[bi])?batches[bi]:[];if(arr.length===0)break outer;for(var ci=0;ci<arr.length;ci++){var c=arr[ci];total++;progressSpan.textContent="取得中… "+total+" 件（メイン）";if(total>=MAX_FETCHED||stop){stop=true;break outer;}var ctime=tms(c);if(cutoff&&ctime&&ctime<cutoff){stop=true;break outer;}var okTime=!cutoff||(ctime&&ctime>=cutoff);var okUser=user===""||(c.author&&c.author.username&&c.author.username.toLowerCase()===user);var okKey=kw===""||((c.content||"").toLowerCase().indexOf(kw.toLowerCase())!==-1);if(okTime&&okUser&&okKey)all.push({type:"コメント",author:c.author&&c.author.username||"?",content:c.content||"",time:ctime,id:c.id});if(stop)break;var replyOffset=0;while(true){if(stop)break;var rurl='https://api.scratch.mit.edu/studios/'+id+'/comments/'+c.id+'/replies?limit='+limit+'&offset='+replyOffset;replyPromises.push(fj(rurl).then(function(reps,parentId){return function(parentId){if(!Array.isArray(reps)||reps.length===0)return;for(var r of reps){total++;progressSpan.textContent="取得中… "+total+" 件（返信）";if(stop)return;var rtime=tms(r);if(cutoff&&rtime&&rtime<cutoff)continue;var rokTime=!cutoff||(rtime&&rtime>=cutoff);var rokUser=user===""||(r.author&&r.author.username&&r.author.username.toLowerCase()===user);var rokKey=kw===""||((r.content||"").toLowerCase().indexOf(kw.toLowerCase())!==-1);if(rokTime&&rokUser&&rokKey)all.push({type:"返信",author:r.author&&r.author.username||"?",content:r.content||"",time:rtime,parent:parentId,id:r.id});}}(c.id);});if(reps.length<limit)break;replyOffset+=limit;if(replyOffset>5000)break;}}}if(replyPromises.length>0){progressSpan.textContent="返信並列取得中…";await Promise.all(replyPromises);}pageIndex+=batch;await new Promise(res=>setTimeout(res,20));}try{progressDiv.remove();}catch(e){}if(all.length===0){alert(stop?"途中で打ち切られました／結果0件":"該当コメントは見つかりませんでした");return;}all.sort((a,b)=>(b.time||0)-(a.time||0));var container=document.createElement("div");container.style.cssText="position:fixed;top:8px;left:8px;right:8px;bottom:8px;overflow:auto;background:#fff;z-index:2147483647;padding:10px;border:2px solid #333;font-size:13px;";var closeBtn=document.createElement("button");closeBtn.textContent="閉じる";closeBtn.style.marginRight="8px";closeBtn.onclick=function(){container.remove();};var info=document.createElement("span");info.textContent="一致: "+all.length+" 件"+(stop?"（途中終了）":"");info.style.marginRight="8px";var header=document.createElement("div");header.style.marginBottom="8px";header.appendChild(closeBtn);header.appendChild(info);container.appendChild(header);var rankCount={};all.forEach(function(x){rankCount[x.author]=(rankCount[x.author]||0)+1;});var ranking=Object.entries(rankCount).sort(function(a,b){return b[1]-a[1];});var rankDiv=document.createElement("div");rankDiv.style.cssText="margin:10px 0;padding:6px;border:1px solid #aaa;background:#f9f9f9;";var rankTitle=document.createElement("div");rankTitle.textContent="◆ コメント数ランキング";rankTitle.style.fontWeight="bold";rankTitle.style.marginBottom="4px";rankDiv.appendChild(rankTitle);ranking.slice(0,10000).forEach(function(r,i){var line=document.createElement("div");line.textContent=(i+1)+"位: "+r[0]+" … "+r[1]+"件";rankDiv.appendChild(line);});container.appendChild(rankDiv);var table=document.createElement("table");table.style.width="100%";table.style.borderCollapse="collapse";var thead=document.createElement("tr");["種別","ユーザー","本文","日時","リンク"].forEach(function(h){var th=document.createElement("th");th.textContent=h;th.style.cssText="border:1px solid #888;padding:6px;background:#eee;";thead.appendChild(th);});table.appendChild(thead);for(var i=0;i<all.length;i++){var r=all[i];var tr=document.createElement("tr");var contentText=r.content||"";if(kw!==""){var re=new RegExp("("+kw.replace(/[.*+?^${}()|[\]\\]/g,"\$&")+")","gi");contentText=contentText.replace(re,'<span style="background-color:yellow;color:red;font-weight:bold;">$1</span>');}var cells=[r.type,r.author,contentText,r.time?new Date(r.time).toLocaleString():"",""];for(var j=0;j<cells.length;j++){var td=document.createElement("td");td.style.cssText="border:1px solid #ddd;padding:6px;";if(j===2)td.innerHTML=cells[j];else if(j===4){var a=document.createElement("a");a.href="https://scratch.mit.edu/studios/"+id+"/comments/#comments-"+r.id;a.target="_blank";a.textContent="開く";td.appendChild(a);}else td.textContent=cells[j];tr.appendChild(td);}table.appendChild(tr);}container.appendChild(table);document.body.appendChild(container);}catch(e){alert("実行エラー: "+e);}})();
