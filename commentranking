javascript:(async function(){try{var m=location.href.match(/\/studios\/(\d+)/);if(!m){alert("スタジオページで実行してください");return;}var id=m[1];var hrs=prompt("何時間以内のコメントを対象にしますか？ (空白＝全件)","");if(hrs===null)return;var hours=hrs.trim()===""?null:parseFloat(hrs.trim());if(hours!==null&&isNaN(hours)){alert("時間は数値で入力してください");return;}var cutoff=hours===null?null:Date.now()-hours*3600*1000;var user=prompt("ユーザー名指定（空白で全員）:","");if(user===null)return;user=user.trim().toLowerCase();var kw=prompt("本文キーワード（空白で全件）:","");if(kw===null)return;kw=kw.trim();var limit=20,batch=15,maxPages=1e12,MAX_FETCHED=1e12;function tms(c){var d=c.datetime_created||c.datetime||c.created_at||c.created||(c.history&&(c.history.created||(Array.isArray(c.history)&&c.history[0]&&c.history[0].modified)));if(!d)return null;var ms=Date.parse(d);if(!isFinite(ms)){var p=String(d).split(/[-T:.Z]/).map(Number);if(p.length>=6)ms=Date.UTC(p[0],p[1]-1,p[2],p[3],p[4],p[5]);else ms=null;}return ms;}async function fj(u,r=3){try{var re=await fetch(u);if(!re.ok)throw new Error("HTTP "+re.status);return await re.json();}catch(e){if(r>0){await new Promise(res=>setTimeout(res,200));return fj(u,r-1);}return[];}}var pageIndex=0,all=[],total=0,stop=false;var progressDiv=document.createElement("div");progressDiv.style.position="fixed";progressDiv.style.top="8px";progressDiv.style.right="8px";progressDiv.style.background="#fff7c0";progressDiv.style.border="1px solid #333";progressDiv.style.padding="6px";progressDiv.style.zIndex=2147483647;progressDiv.style.fontSize="13px";progressDiv.style.borderRadius="6px";var progressSpan=document.createElement("span");progressSpan.textContent="取得中… 0 件";var stopBtn=document.createElement("button");stopBtn.textContent="途中終了";stopBtn.style.marginLeft="8px";stopBtn.onclick=function(){stop=true;stopBtn.disabled=true;stopBtn.textContent="停止中...";};progressDiv.appendChild(progressSpan);progressDiv.appendChild(stopBtn);document.documentElement.appendChild(progressDiv);outer:while(true){if(pageIndex>=maxPages||stop)break;var pages=[];for(var i=0;i<batch&&(pageIndex+i)<maxPages;i++)pages.push(pageIndex+i);if(pages.length===0)break;var urls=pages.map(pi=>'https://api.scratch.mit.edu/studios/'+id+'/comments?limit='+limit+'&offset='+pi*limit);var batches=await Promise.all(urls.map(u=>fj(u)));var replyPromises=[];for(var bi=0;bi<batches.length;bi++){var arr=Array.isArray(batches[bi])?batches[bi]:[];if(arr.length===0)break outer;for(var ci=0;ci<arr.length;ci++){var c=arr[ci];total++;if(total%20===0)progressSpan.textContent="取得中… "+total+" 件";if(total>=MAX_FETCHED||stop){stop=true;break outer;}var ctime=tms(c);if(cutoff&&ctime&&ctime<cutoff){stop=true;break outer;}var okTime=!cutoff||(ctime&&ctime>=cutoff);var okUser=user===""||(c.author&&c.author.username&&c.author.username.toLowerCase()===user);var okKey=kw===""||((c.content||"").toLowerCase().indexOf(kw.toLowerCase())!==-1);if(okTime&&okUser&&okKey)all.push({type:"コメント",author:c.author&&c.author.username||"?",content:c.content||"",time:ctime,id:c.id});if(c.reply_count>0){(function(c_id){replyPromises.push((async function(){var ro=0;while(true){var rurl='https://api.scratch.mit.edu/studios/'+id+'/comments/'+c_id+'/replies?limit='+limit+'&offset='+ro;var reps=await fj(rurl);if(!Array.isArray(reps)||reps.length===0)break;for(var r of reps){total++;if(total%20===0)progressSpan.textContent="取得中… "+total+" 件";if(total>=MAX_FETCHED||stop)return;var rtime=tms(r);if(cutoff&&rtime&&rtime<cutoff)return;var rokTime=!cutoff||(rtime&&rtime>=cutoff);var rokUser=user===""||(r.author&&r.author.username&&r.author.username.toLowerCase()===user);var rokKey=kw===""||((r.content||"").toLowerCase().indexOf(kw.toLowerCase())!==-1);if(rokTime&&rokUser&&rokKey)all.push({type:"返信",author:r.author&&r.author.username||"?",content:r.content||"",time:rtime,parent:c_id,id:r.id});}if(reps.length<limit)break;ro+=limit;}})());})(c.id);}}if(stop)break;}if(stop)break;}await Promise.all(replyPromises);pageIndex+=batch;}try{document.documentElement.removeChild(progressDiv);}catch(e){}if(all.length===0){alert(stop?"途中で打ち切られました／結果0件":"該当コメントは見つかりませんでした");return;}all.sort((a,b)=>(b.time||0)-(a.time||0));var container=document.createElement("div");container.style.position="fixed";container.style.top="8px";container.style.left="8px";container.style.right="8px";container.style.bottom="8px";container.style.overflow="auto";container.style.background="#fff";container.style.zIndex=2147483647;container.style.padding="10px";container.style.border="2px solid #333";container.style.fontSize="13px";var closeBtn=document.createElement("button");closeBtn.textContent="閉じる";closeBtn.style.marginRight="8px";closeBtn.onclick=function(){container.remove();};var info=document.createElement("span");info.textContent='一致: '+all.length+' 件'+(stop?"（途中終了）":"");info.style.marginRight="8px";var header=document.createElement("div");header.style.marginBottom="8px";header.appendChild(closeBtn);header.appendChild(info);container.appendChild(header);var rankCount={};all.forEach(x=>{rankCount[x.author]=(rankCount[x.author]||0)+1;});var ranking=Object.entries(rankCount).sort((a,b)=>b[1]-a[1]);var rankDiv=document.createElement("div");rankDiv.style.margin="10px 0";rankDiv.style.padding="6px";rankDiv.style.border="1px solid #aaa";rankDiv.style.background="#f9f9f9";var rankTitle=document.createElement("div");rankTitle.textContent="◆ コメント数ランキング";rankTitle.style.fontWeight="bold";rankTitle.style.marginBottom="4px";rankDiv.appendChild(rankTitle);ranking.slice(0,10000).forEach((r,i)=>{var line=document.createElement("div");line.textContent=(i+1)+"位: "+r[0]+" … "+r[1]+"件";rankDiv.appendChild(line);});container.appendChild(rankDiv);var table=document.createElement("table");table.style.width="100%";table.style.borderCollapse="collapse";var thead=document.createElement("tr");["種別","ユーザー","本文","日時","リンク"].forEach(function(h){var th=document.createElement("th");th.textContent=h;th.style.border="1px solid #888";th.style.padding="6px";th.style.background="#eee";thead.appendChild(th);});table.appendChild(thead);for(var rr=0;rr<all.length;rr++){var r=all[rr];var tr=document.createElement("tr");var contentText=r.content||"";if(kw!==""){var re=new RegExp("("+kw.replace(/[.*+?^${}()|[\\]\\\\]/g,"\\$&")+")","gi");contentText=contentText.replace(re,'<span style="background-color:yellow;color:red;font-weight:bold;">$1</span>');}var cells=[r.type,r.author,contentText,r.time?new Date(r.time).toLocaleString():"",""];for(var ci=0;ci<cells.length;ci++){var td=document.createElement("td");td.style.border="1px solid #ddd";td.style.padding="6px";if(ci===2)td.innerHTML=cells[ci];else if(ci===4){var a=document.createElement("a");a.href='https://scratch.mit.edu/studios/'+id+'/comments/#comments-'+r.id;a.target="_blank";a.textContent="開く";td.appendChild(a);}else td.textContent=cells[ci];tr.appendChild(td);}table.appendChild(tr);}container.appendChild(table);document.body.appendChild(container);}catch(e){alert("実行エラー:"+e);}})();
